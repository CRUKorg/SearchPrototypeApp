!function(global){"use strict";global.app=angular.module("searchPrototypeApp",["ui.router","ngSanitize","elasticsearch","ui.bootstrap","duScroll","angulartics","angulartics.google.analytics"]),global.app.config(function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("search"),$stateProvider.state("search",{url:"/search?query&page",controller:"SearchController",controllerAs:"ctrl",params:{query:{value:"",squash:!0},page:{value:"1",squash:!0}},templateUrl:"search.html"})})}(this),function(){"use strict";app.filter("dateos",["$filter",function($filter){var suffixes=["th","st","nd","rd"];return function(string,format,timezone){if(!angular.isString(string))return string;if(format=format||"mediumDate",timezone=timezone||null,-1===format.indexOf("S"))return $filter("date")(string,format,timezone);var dtfilter=$filter("date")(string,format,timezone),day=parseInt(dtfilter.slice(-2)),relevantDigits=30>day?day%20:day%30,suffix=3>=relevantDigits?suffixes[relevantDigits]:suffixes[0];return $filter("date")(string,format,timezone).replace("S",suffix)}}])}(),function(){"use strict";app.filter("highlightmatches",function(){return function(string){return angular.isString(string)?string.split("[mark]").join("<mark>").split("[/mark]").join("</mark>"):string}})}(),function(){"use strict";app.filter("htmlsafe",["$sce",function($sce){return function(string){return $sce.trustAsHtml(string)}}])}(),function(){"use strict";app.filter("plaintext",function(){return function(string){return angular.isString(string)?string.replace(/<(?:.|\n)*?>/gm,""):string}})}(),function(){"use strict";app.filter("trim",function(){return function(string){return angular.isString(string)?"function"!=typeof String.prototype.trim?string.trim():string.replace(/^\s+|\s+$/g,""):string}})}(),function(){"use strict";app.provider("configurationService",function(){var self=this;self.appSettings={host:"",index:"",resultsPerPage:10,debug:!1,strings:{}},"undefined"!=typeof crukSearch&&"undefined"!=typeof crukSearch.config&&angular.merge(self.appSettings,crukSearch.config),self.setSettingValue=function(name,value){self.appSettings[name]=value},self.get=function(){return self.appSettings},self.getSetting=function(key,fallback){fallback="undefined"!=typeof fallback?fallback:"";var setting=self.appSettings;return angular.isString(key)&&(key=[key]),angular.isArray(key)?(angular.forEach(key,function(value){setting=setting[value]}),setting):fallback},self.set=function(data){self.appSettings=data},self.getString=function(name,values){values=values||{};var regExp=/@(\w*)@/gi;return self.appSettings.strings[name].replace(regExp,function(match){return match=match.replace(/@/gi,""),values[match]})},self.$get=function(){return{appSettings:self.appSettings,get:self.get,set:self.set,getSetting:self.getSetting,setSettingValue:self.setSettingValue,getString:self.getString}}})}(),function(){"use strict";app.controller("SearchController",["configurationService","ElasticService","esFactory","$sanitize","$state","$stateParams","$location","$document","$log",function(config,ElasticService,esFactory,$sanitize,$state,$stateParams,$location,$document,$log){var self=this;self.search={text:decodeURI($stateParams.query)||"",input:decodeURI($stateParams.query)||"",page:parseInt($stateParams.page)||1},self.alerts=[],self.results=[],self.totalItems=0,self.resultsPerPage=config.getSetting("resultsPerPage",10),self.failedSearch=!1,self.searchSubmit=function(){""!==self.search.input&&self.search.input!=self.search.text&&(self.search.text=self.search.input,self.search.page=1,self.executeSearch(self.search.input,!0),self.updateState(self.search.text,self.search.page))},self.executeSearch=function(text,newSearch){self.alertsClear(),newSearch=newSearch||!1,ElasticService.search({index:config.getSetting("index",""),from:(self.search.page-1)*self.resultsPerPage,size:self.resultsPerPage,body:{query:{multi_match:{type:"phrase",fields:["title","body:value"],query:text,analyzer:"news"}},fields:["title","field_published","field_type","body:value","field_url:url"],highlight:{pre_tags:["[mark]"],post_tags:["[/mark]"],fragment_size:150,number_of_fragments:3,fields:{title:{},"body:value":{}}}}}).then(function(body){self.alertsClear(),self.results=body.hits.hits,self.totalItems=body.hits.total,self.totalItems<1?self.noResults():(self.failedSearch=!1,self.alertsAdd("Your search for <strong>&quot;"+self.search.input+"&quot;</strong> found <strong>"+self.totalItems+"</strong> results in <strong>"+body.took+"</strong> milliseconds!","success"))},function(error){self.alertsAdd($sanitize(error.message),"danger")})},self.buildExcerpt=function(fieldData,highlightData){},self.noResults=function(){self.failedSearch=!0,self.alertsAdd("Your search for <strong>&quot;"+self.search.input+"&quot;</strong> returned no results","warning")},self.alertsAdd=function(message,type){type=type||"info",self.alerts.push({msg:message,type:type})},self.alertsClear=function(){self.alerts=[]},self.setPage=function(){self.executeSearch(self.search.text),$document.scrollTopAnimated(0)},self.updateState=function(text,page){console.log($stateParams.page),console.log(page);var decoded_query=decodeURI(self.search.text);decoded_query===text&&$stateParams.page===page||$state.go("search",{query:encodeURI(text),page:self.search.page},{notify:!0})},""!==self.search.text&&self.executeSearch(self.search.text)}])}(),function(){"use strict";app.service("ElasticService",["esFactory","configurationService",function(esFactory,config){return esFactory({host:config.getSetting("host",""),apiVersion:"2.3",log:config.getSetting("debug",!1)?"trace":"error"})}])}();