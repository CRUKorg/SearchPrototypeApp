(function (global) {
  'use strict';

  global.app = angular.module('searchPrototypeApp', [
    'templateCache',
    'ui.router',
    'ngSanitize',
    'elasticsearch',
    'ui.bootstrap',
    'duScroll',
    'angulartics',
    'angulartics.google.analytics'
  ]);

  /**
   * Define our routes.
   */
  global.app.config(function($stateProvider, $urlRouterProvider, $analyticsProvider) {
    /**
     * Set the apps pages.
     */
    $urlRouterProvider.otherwise('search');

    $stateProvider.state('search', {
      url: '/search?query&page',
      controller: 'SearchController',
      controllerAs: 'ctrl',
      params: {
        query: {
          value: '',
          squash: true
        },
        page: {
          value: '1',
          squash: true
        }
      },
      templateUrl: 'search/controllers/search.html'
    });

    /**
     * Disable automatic analytics page views, we'll do this manually.
     */
    $analyticsProvider.virtualPageviews(false);
  });

}(this));
(function () {
  'use strict';

  app.controller('SearchController', ['$scope', 'configurationService', 'ElasticService', 'esFactory', '$sanitize', '$state', '$stateParams', '$document', '$log', '$analytics',
    function($scope, config, ElasticService, esFactory, $sanitize, $state, $stateParams, $document, $log, $analytics) {
      var self = this;

      /**
       * Setup variables.
       */
      self.search = {
        text: decodeURI($stateParams.query) || '',
        page: parseInt($stateParams.page) || 1
      };

      /**
       * Results vars.
       */
      self.results = [];
      self.totalItems = 0;
      self.resultsPerPage = config.getSetting('resultsPerPage', 10);
      self.failedSearch = false;
      self.loading = false;

      /**
       * Execute a search against Elastic.
       *
       * @param {string} text The query to run against Elastic.
       */
      self.executeSearch = function(text) {
        if (text.trim() === '') {
          return;
        }

        if (config.getSetting('debug', false)) {
          $log.log('Do a search for ' + text, self.search);
        }

        self.loading = true;

        ElasticService.search({
          index: config.getSetting('index', ''),
          from: (self.search.page - 1) * self.resultsPerPage,
          size: self.resultsPerPage,
          body: {
            query: {
              multi_match: {
                type: 'phrase',
                fields: ['title', 'body:value'],
                query: text,
                analyzer: 'news'
                //fuzziness: 'AUTO'
              }
            },
            fields: ['title', 'field_published', 'field_type', 'body:value', 'field_url:url'],
            highlight: {
              pre_tags: ['[mark]'],
              post_tags: ['[/mark]'],
              //encoder: 'html',
              fragment_size: 80,
              number_of_fragments: 3,
              fields: {
                title: {},
                'body:value': {}
              }
            }
          }
        }).then(function (body) {
          self.results = body.hits.hits;
          self.totalItems = body.hits.total;
          self.loading = false;

          if (config.getSetting('debug', false)) {
            $log.log('The search request found ' + self.totalItems + 'results...', self.results);
          }

          if (self.totalItems < 1) {
            self.noResults();
          }
          else {
            /**
             * Scroll to the top of the page.
             */
            $document.scrollTopAnimated(0);

            /**
             * Note that the search was successful.
             */
            self.failedSearch = false;
          }

          // Update the page state.
          self.updateState(self.search.text, self.search.page);
        }, function (error) {
          $log.log('Ruh roh, sometihng went wrong when talking to Elastic... ' + $sanitize(error.message));
        });
      };

      /**
       * Output a message stating no results have been found. At this point
       * trigger any specific GA reporting.
       */
      self.noResults = function() {
        self.failedSearch = true;
        $analytics.eventTrack('searchNoResults', {category: 'News prototype search', label: 'No results'});
      };

      /**
       * Set the page of results to view.
       */
      self.setPage = function() {
        /**
         * Track page change event.
         */
        $analytics.eventTrack('searchPaged', {category: 'News prototype search ', label: 'Search paged'});

        /**
         * Execute the search of the next page.
         */
        self.executeSearch(self.search.text);
      };

      /**
       * Update state.
       */
      self.updateState = function(text, page) {
        var decoded_query = decodeURI(self.search.text);
        var encoded_query = encodeURI(text);

        if ($stateParams.query !== encoded_query || $stateParams.page !== page) {
          /**
           * Push events to analytics (GA).
           */
          if ($stateParams.query !== encoded_query) {
            $analytics.pageTrack('/search?query=' + encoded_query);
            $analytics.eventTrack('search', {category: 'News prototype search ', label: 'Search'});
          }

          /**
           * Update the application state/URL.
           */
          $state.go('.', {query: encoded_query, page: self.search.page}, {notify: false});
        }
      };

      $scope.$on('searchSubmitted', function(event, data){
        self.search.text = data.query;
        if ($stateParams.query !== encodeURI(self.search.text)) {
          self.search.page = 1;
        }

        self.executeSearch(self.search.text);
      });
    }]);

}());
angular.module('templateCache', []).run(['$templateCache', function($templateCache) {$templateCache.put('results/components/ResultsComponent.html','          <a name="results"></a>\n\n          <div class="search-loading" ng-show="$ctrl.loading">\n            <div class="spinner">\n              <div class="bounce1"></div>\n              <div class="bounce2"></div>\n              <div class="bounce3"></div>\n            </div>\n          </div>\n\n          <ul class="search-results" ng-show="$ctrl.results">\n            <li class="search-result" ng-repeat="doc in $ctrl.results">\n              <div class="media-body">\n                <h4 class="search-result__title"><a href="{{doc.fields[\'field_url:url\'][0]}}">{{doc.fields.title[0] | plaintext | trim}}</a></h4>\n                <ul class="search-result__meta">\n                  <li><strong>{{doc.fields.field_type[0]}}</strong></li>\n                  <li><strong>Published:</strong> {{doc.fields.field_published[0] | dateos:\'dS MMMM yyyy\'}}</li>\n                </ul>\n                <p class="search-result__excerpt" ng-bind-html="doc.highlight[\'body:value\'].join(\'... \') | plaintext | highlightmatches"></p>\n              </div>\n            </li>\n          </ul>');
$templateCache.put('input/components/InputComponent.html','          <form role="search" name="searchForm" ng-submit="$ctrl.searchSubmit();">\n            <div class="cr-input-group cr-input-group--lg cr-search-input">\n              <label for="search-input" id="search-label">Search...</label>\n              <input type="search" class="cr-input-group__input cr-search-input__input" id="search-input" placeholder="Search..." aria-describedby="search-label" autocomplete="off" autocorrect="off" ng-model="$ctrl.search.query">\n              <span class="cr-input-group__button cr-search-input__button">\n                <button type="submit" class="btn" aria-label="Submit your search"><span class="cr-input-group__icon glyphicon glyphicon-search" aria-hidden="true"></span></button>\n              </span>\n            </div>\n          </form>');
$templateCache.put('search/components/SearchComponent.html','    <div id="searchPrototypeApp" class="container">\n      <div class="row">\n        <div class="col-xs-12 col-sm-8 col-sm-push-2">\n\n        <search-input></search-input>\n\n        </div>\n      </div>\n\n      <div class="row">\n        <div class="col-xs-12 col-sm-8 col-sm-push-2">\n\n          <search-summary></search-summary>\n\n          <a name="results"></a>\n\n          <search-results></search-results>\n\n          <uib-pager total-items="$ctrl.totalItems" items-per-page="$ctrl.resultsPerPage" ng-model="$ctrl.search.page" ng-change="$ctrl.setPage()" ng-if="$ctrl.results.length > 0" ng-disabled="ctrl.loading"></uib-pager>\n\n        </div>\n      </div>\n    </div>\n');
$templateCache.put('search/controllers/search.html','    <div id="searchPrototypeApp" class="container">\n      <div class="row">\n        <div class="col-xs-12 col-sm-8 col-sm-push-2">\n\n        <search-input></search-input>\n\n        </div>\n      </div>\n\n      <div class="row">\n        <div class="col-xs-12 col-sm-8 col-sm-push-2">\n\n          <search-summary text="ctrl.search.text" total-items="ctrl.totalItems" failed-search="ctrl.failedSearch"></search-summary>\n\n          <search-results results="ctrl.results" total-items="ctrl.totalItems" loading="ctrl.loading" page="ctrl.search.page"></search-results>\n\n          <uib-pager total-items="ctrl.totalItems" items-per-page="ctrl.resultsPerPage" ng-model="ctrl.search.page" ng-change="ctrl.setPage()" ng-if="ctrl.results.length > 0"></uib-pager>\n\n        </div>\n      </div>\n    </div>\n');
$templateCache.put('summary/components/SummaryComponent.html','  <div class="search-summary alert" ng-class="$ctrl.totalItems > 0 ? \'alert-info\' : \'alert-warning\'" ng-if="$ctrl.totalItems > 0 || $ctrl.failedSearch" role="alert">\n    <span ng-show="$ctrl.totalItems > 0">Your search for <strong>&quot;<span ng-bind-html="$ctrl.text | htmlsafe"></span>&quot;</strong> found <strong>{{$ctrl.totalItems}}</strong> results!</span>\n    <span ng-show="$ctrl.failedSearch">Your search for <strong>&quot;<span ng-bind-html="$ctrl.text | htmlsafe"></span>&quot;</strong> didn\'t return any results <span class="emoji"><img alt=":C" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAMAAADDpiTIAAABTVBMVEUAAAD/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wf/3Wdlse9lse9lse9lse9lse9lse9lse9lse9lse9lse9lse9lse9lse9lse9lse9lse+8yqP12nBvtOefwrzi1YGMvM3Pz5J4t96yx6vs2HjFzZqCudbZ0omVv8WoxLTkw1bqylrWtk7PsErx0F+6nD2RdST412OmiTGtjzWYfCifgizBo0HIqUbdvVKzljnQvmdrqtZ4l5aJgEp+j32MfT12m6OGhFdworyOeTForeKDiGNznrCqk0GMvM3sy1/Gp0+pjUOMcjd5YC9mTifPsFOfhD9wVyvZuVeWezuzlkeDaTP11GPiwlu8nktwWTWMel2pm4azp5PPyLzZ08ns6eT///95ZEKDb1C8sqGWhWvGva719PLi3tefkHhrkquyAAAAT3RSTlMAEEBQgK+/z//vYI9wnzAg3zDvYP8Qz6+fcFDfv4+AIED///////////////////////////////////////////////////////////+AhK9SsAAAE21JREFUeAHs2oeioywQBeBBEQeMJWZMb39v7/98f1+2bxLNvVfgfK9wEKZIAAAAAAAAAAAAAAAAAAAAAMFSWZZrrQtjTMlfVBpjCq11nmWKIBLqn9iNsfwga4zWOU5CyMk7bUqezBjtcA7CkrnKWH4qayqX0exBtqhLfjFlvchopqBxdcmvoKxdQ/MCmS4svyJb6IzmAZqF4TdhFg29LWhdYfkN2cK19EYgq0qegbLKCF6bymvLs2HrXBG8GuUKnp3CKYKg0w/gDIAreNYKR/Bistry7Nk6I3gBre44EJ1uCQK5+gN4CqDVloNjq5bgGfKCA1VkNBEo13HAukmNIbSV5ekCfQmgqTkKdUPwuMxwNExGkEz8048AuI6j0zl6tmW/QvwJH4FlL/0Sl3+yD8GwFpF+ifgTPAI+f5H1QBFpDUfPtPQUG/nPOqL4a05C3dJ0W3lnS3FQ2nIirFY00Ure21EMnOWEWEeT7OVDe9R+iVWDy168GFoBVXOCakUjDQfxYmgFFpaTZBc0zlE+taFwNSUnq2xohJN87kyBUhUnrVKTGoDgC8G848R1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"></span></span>\n  </div>\n');}]);
(function () {
  'use strict';

  app.component('searchInput', {
    bindings: {},
    templateUrl: 'input/components/InputComponent.html',
    controller: ['$scope', '$stateParams', function($scope, $stateParams) {
      var self = this;
      self.search = {
        query: $stateParams.query,
        previousQuery: null
      };

      self.searchSubmit = function() {
        if (self.search.query !== '' && self.search.query !== self.search.previousQuery) {
          self.search.previousQuery = self.search.query;
          $scope.$emit('searchSubmitted', self.search);
        }
      };

      self.$onInit = function() {
        self.searchSubmit();
      };
    }]
  });

}());
(function () {
  'use strict';

  /**
   * Provide a date filter which accepts the extra format character "S" which
   * will be replaced with an ordinal suffix.
   *
   * @return {string} A formatted date.
   */
  app.filter('dateos', ['$filter', function($filter) {
    var suffixes = ['th', 'st', 'nd', 'rd'];

    return function(string, format, timezone) {
      if (!angular.isString(string)) {
        return string;
      }

      format = format || 'mediumDate';
      timezone = timezone || null;

      /**
       * If the ordinal suffix character "S" isn't in the format string, just
       * use the date filter.
       */
      if (format.indexOf('S') === -1) {
        return $filter('date')(string, format, timezone);
      }

      var dtfilter = $filter('date')(string, format, timezone);
      var day = parseInt(dtfilter.slice(-2));
      var relevantDigits = (day < 30) ? day % 20 : day % 30;
      var suffix = (relevantDigits <= 3) ? suffixes[relevantDigits] : suffixes[0];

      return $filter('date')(string, format, timezone).replace('S', suffix);
    };
  }]);

}());
(function () {
  'use strict';

  /**
   * Returns a string which has any HTML tags removed.
   *
   * http://stackoverflow.com/questions/822452/strip-html-from-text-javascript
   *
   * @param {string} string
   *   The string to mark as safe.
   * @return {string} plain text string
   */
  app.filter('highlightmatches', function() {
    return function(string) {
      if (!angular.isString(string)) {
        return string;
      }
      return string.split('[mark]').join('<mark>').split('[/mark]').join('</mark>');
    };
  });

}());
/**
 * Created by fechit01 on 03/05/2016.
 */

(function () {
  'use strict';

  /**
   * Marks a string as HTML safe.
   * @param {string} string
   *   The string to mark as safe.
   * @return safeString
   */
  app.filter('htmlsafe', ['$sce', function($sce) {
    return function(string) {
      return $sce.trustAsHtml(string);
    };
  }]);

}());
(function () {
  'use strict';

  /**
   * Returns a string which has any HTML tags removed.
   *
   * http://stackoverflow.com/questions/822452/strip-html-from-text-javascript
   *
   * @param {string} string
   *   The string to mark as safe.
   * @return {string} plain text string
   */
  app.filter('plaintext', function() {
    return function(string) {
      if (!angular.isString(string)) {
        return string;
      }
      return string.replace(/<(?:.|\n)*?>/gm, '');
    };
  });

}());
(function () {
  'use strict';

  /**
   * Returns a string without any whitespace on either end of it. To ensure
   * compatibility with older browsers regex is used rather than .trim().
   *
   * http://stackoverflow.com/questions/30506300/how-do-i-trim-a-string-in-angularjs
   *
   * @param {string} string
   *   The string to process.
   * @return {string}
   */
  app.filter('trim', function() {
    return function(string) {
      if (!angular.isString(string)) {
        return string;
      }
      return typeof String.prototype.trim !== 'function' ? string.trim() : string.replace(/^\s+|\s+$/g, '');
    };
  });

}());
(function () {
  'use strict';

  app.provider('configurationService', function () {
    var self = this;

    self.appSettings = {
      'host': '',
      'index': '',
      'resultsPerPage': 10,
      'debug': false,
      'strings': {}
    };

    if (typeof crukSearch !== 'undefined') {
      if (typeof crukSearch.config !== 'undefined') {
        angular.merge(self.appSettings, crukSearch.config);
      }
    }

    self.setSettingValue = function (name, value) {
      self.appSettings[name] = value;
    };

    self.get = function() {
      return self.appSettings;
    };

    /**
     * Gets an app setting.
     *
     * In the case where a nested setting is required, an array of properties in order of nesting may be supplied.
     * @param {string|string[]} key
     * @returns {string|int}
     */
    self.getSetting = function(key, fallback) {
      fallback = typeof fallback !== 'undefined' ? fallback : '';
      var setting = self.appSettings;

      if (angular.isString(key)) {
        key = [key];
      }

      if (!angular.isArray(key)) {
        return fallback;
      }

      angular.forEach(key, function(value) {
        setting = setting[value];
      });

      return setting;
    };

    self.set = function(data) {
      self.appSettings = data;
    };

    self.getString = function (name, values) {
      values = values || {};
      var regExp = /@(\w*)@/gi;
      return self.appSettings.strings[name].replace(regExp, function (match) {
        match = match.replace(/@/gi, '');
        return values[match];
      });
    };

    self.$get = function() {
      return {
        appSettings: self.appSettings,
        get: self.get,
        set: self.set,
        getSetting : self.getSetting,
        setSettingValue: self.setSettingValue,
        getString: self.getString
      };
    };
  });

}());
(function () {
  'use strict';

  app.component('searchResults', {
    controller: 'SearchController',
    bindings: {
      results: '<',
      totalItems: '<',
      loading: '<',
      page: '<'
    },
    templateUrl: 'results/components/ResultsComponent.html'
  });

}());
(function () {
  'use strict';

  app.component('searchInterface', {
    templateUrl: 'search/components/SearchComponent.html',
    controller: ['$scope', 'configurationService', 'ElasticService', 'esFactory', '$sanitize', '$state', '$stateParams', '$document', '$log', '$analytics',
      function($scope, config, ElasticService, esFactory, $sanitize, $state, $stateParams, $document, $log, $analytics) {
        var self = this;

        /**
         * Define the search data object.
         */
        this.search = {
          text: decodeURI($stateParams.query) || '',
          page: parseInt($stateParams.page) || 1
        };
        self.search = this.search;

        /**
         * Results & response storage.
         */
        self.results = [];
        self.totalItems = 0;
        self.resultsPerPage = config.getSetting('resultsPerPage', 10);
        self.failedSearch = false;

        /**
         * Execute a search against Elastic.
         *
         * @param {string} text The query to run against Elastic.
         */
        self.executeSearch = function(text) {
          console.log('do a search for ' + text, self.search);
          ElasticService.search({
            index: config.getSetting('index', ''),
            from: (self.search.page - 1) * self.resultsPerPage,
            size: self.resultsPerPage,
            body: {
              query: {
                multi_match: {
                  type: 'phrase',
                  fields: ['title', 'body:value'],
                  query: text,
                  analyzer: 'news'
                  //fuzziness: 'AUTO'
                }
              },
              fields: ['title', 'field_published', 'field_type', 'body:value', 'field_url:url'],
              highlight: {
                pre_tags: ['[mark]'],
                post_tags: ['[/mark]'],
                //encoder: 'html',
                fragment_size: 80,
                number_of_fragments: 3,
                fields: {
                  title: {},
                  'body:value': {}
                }
              }
            }
          }).then(function (body) {
            //self.search.page = 1;
            self.results = body.hits.hits;
            self.totalItems = body.hits.total;
  console.log(self.results);
            if (self.totalItems < 1) {
              self.noResults();
            }
            else {
              self.failedSearch = false;
            }

            // Update the page state.
            self.updateState(self.search.text, self.search.page);
          }, function (error) {
            $log.log('Ruh roh, sometihng went wrong when talking to Elastic... ' + $sanitize(error.message));
          });
        };

        /**
         * Output a message stating no results have been found. At this point
         * trigger any specific GA reporting.
         */
        self.noResults = function() {
          self.failedSearch = true;
          $analytics.eventTrack('searchNoResults', {category: 'News prototype search', label: 'No results'});
        };

        /**
         * Set the page of results to view.
         */
        self.setPage = function() {
          /**
           * Track page change event.
           */
          $analytics.eventTrack('searchPaged', {category: 'News prototype search ', label: 'Search paged'});

          /**
           * Execute the search of the next page.
           */
          self.executeSearch(self.search.text);
        };

        /**
         * Update state.
         */
        self.updateState = function(text, page) {
          var decoded_query = decodeURI(self.search.text);
          var encoded_query = encodeURI(text);

          if ($stateParams.query !== encoded_query || $stateParams.page !== page) {
            /**
             * Push events to analytics (GA).
             */
            if ($stateParams.query !== encoded_query) {
              $analytics.pageTrack('/search?query=' + encoded_query);
              $analytics.eventTrack('search', {category: 'News prototype search ', label: 'Search'});
            }

            /**
             * Scroll to the top of the page.
             */
            if ($stateParams.page !== page) {
              $document.scrollTopAnimated(0);
            }

            /**
             * Update the application state/URL.
             */
            //$state.go('search', {query: encoded_query, page: self.search.page}, {notify: true});
          }
        };

        /**
         * Execute a search if the default state says so.
         */
        if (self.search.text !== '') {
          //self.executeSearch(self.search.text);
        }

        $scope.$on('searchSubmitted', function(event, data){
          self.search.text = data.query;
          self.search.page = 1;

          self.executeSearch(self.search.text);
        });


      }
    ]
  });

}());
(function () {
  'use strict';

  /**
   * Define the ElasticSearch service as per...
   * https://github.com/elastic/bower-elasticsearch-js
   */
  app.service('ElasticService', ['esFactory', 'configurationService',
    function (esFactory, config) {
      return esFactory({
        host: config.getSetting('host', ''),
        apiVersion: '2.3',
        log: config.getSetting('debug', false) ? 'trace' : 'error'
      });
  }]);

}());
(function () {
  'use strict';

  app.component('searchSummary', {
    controller: 'SearchController',
    bindings: {
      text: '<',
      totalItems: '<',
      failedSearch: '<',
    },
    templateUrl: 'summary/components/SummaryComponent.html',
  });

}());